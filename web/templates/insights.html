{% extends "base.html" %}

{% block title %}Insights - ContentCreationEngine{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>
            <i class="bi bi-graph-up text-success me-2"></i>
            Insights & Analysis
        </h1>
        <p class="text-muted">AI-powered insights extracted from your research data for strategic planning and content optimization.</p>
    </div>
</div>

<!-- Generate New Insights -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-magic me-2"></i>Generate New Insights</h5>
    </div>
    <div class="card-body">
        <form id="generateInsightsForm">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="personaSelect" class="form-label">Select Persona</label>
                    <select class="form-select" id="personaSelect" required>
                        <option value="">Choose a persona...</option>
                        {% for persona in personas %}
                        <option value="{{ persona }}">{{ persona }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="researchSelect" class="form-label">Select Research Run</label>
                    <select class="form-select" id="researchSelect" required>
                        <option value="">Choose a research run...</option>
                        {% for research in research_runs %}
                        <option value="{{ research.filename }}">{{ research.date }} ({{ research.source_count }} sources)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Analysis Types</label>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="trending_topics" id="chkTrending" checked>
                            <label class="form-check-label" for="chkTrending">Trending Topics</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="audience_pain_points" id="chkPainPoints" checked>
                            <label class="form-check-label" for="chkPainPoints">Pain Points</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="content_gaps" id="chkGaps" checked>
                            <label class="form-check-label" for="chkGaps">Content Gaps</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="competitor_analysis" id="chkCompetitor" checked>
                            <label class="form-check-label" for="chkCompetitor">Competitors</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="engagement_patterns" id="chkEngagement" checked>
                            <label class="form-check-label" for="chkEngagement">Engagement</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="keyword_opportunities" id="chkKeywords" checked>
                            <label class="form-check-label" for="chkKeywords">Keywords/GEO</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="strategic_recommendations" id="chkStrategic" checked>
                            <label class="form-check-label" for="chkStrategic">Strategy</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100" id="btnGenerate">
                        <i class="bi bi-lightning-charge me-1"></i> Analyze
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Progress -->
        <div id="progressContainer" class="mt-3 d-none">
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="text-center mt-2 mb-0" id="progressMessage">Initializing...</p>
        </div>
    </div>
</div>

<!-- Insights List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Generated Insights</h5>
        <span class="badge bg-primary">{{ insights_list|length }} reports</span>
    </div>
    <div class="card-body">
        {% if insights_list %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Persona</th>
                        <th>Niche</th>
                        <th>Analyses</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for insight in insights_list %}
                    <tr style="cursor: pointer;" onclick="window.location='/insights/{{ insight.persona_id }}/{{ insight._filename }}'">
                        <td>{{ insight.generated_at[:19] if insight.generated_at else 'Unknown' }}</td>
                        <td><span class="badge bg-primary">{{ insight.persona_id }}</span></td>
                        <td>{{ insight.niche }}</td>
                        <td>{{ insight.analyses|length if insight.analyses else 0 }} types</td>
                        <td>
                            <a href="/insights/{{ insight.persona_id }}/{{ insight._filename }}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation()">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-graph-up fs-1 text-muted"></i>
            <h4 class="mt-3 text-muted">No Insights Yet</h4>
            <p class="text-muted">Generate your first insights report to see AI-powered analysis of your research data.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentJobId = null;
let pollInterval = null;

// Handle persona change to filter research runs
document.getElementById('personaSelect').addEventListener('change', async function(e) {
    const personaId = this.value;
    const researchSelect = document.getElementById('researchSelect');
    
    if (!personaId) {
        researchSelect.innerHTML = '<option value="">Choose a research run...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/insights/research-runs?persona_id=${personaId}`);
        const researchRuns = await response.json();
        
        // Clear existing options except the placeholder
        researchSelect.innerHTML = '<option value="">Choose a research run...</option>';
        
        // Add research runs for this persona
        researchRuns.forEach(run => {
            const option = document.createElement('option');
            option.value = run.filename;
            option.textContent = `${run.date} (${run.source_count} sources)`;
            researchSelect.appendChild(option);
        });
    } catch (err) {
        console.error('Error loading research runs:', err);
        alert('Failed to load research runs');
    }
});

// Trigger initial load on page load
document.addEventListener('DOMContentLoaded', function() {
    const personaSelect = document.getElementById('personaSelect');
    if (personaSelect.value) {
        personaSelect.dispatchEvent(new Event('change'));
    }
});

document.getElementById('generateInsightsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const personaId = document.getElementById('personaSelect').value;
    if (!personaId) {
        alert('Please select a persona');
        return;
    }
    
    const researchFile = document.getElementById('researchSelect').value;
    if (!researchFile) {
        alert('Please select a research run');
        return;
    }
    
    // Get selected analysis types
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    const analysisTypes = Array.from(checkboxes).map(cb => cb.value);
    
    if (analysisTypes.length === 0) {
        alert('Please select at least one analysis type');
        return;
    }
    
    // Disable form and show progress
    document.getElementById('btnGenerate').disabled = true;
    document.getElementById('progressContainer').classList.remove('d-none');
    document.getElementById('progressBar').style.width = '5%';
    document.getElementById('progressMessage').textContent = 'Starting analysis...';
    
    try {
        const response = await fetch('/api/insights/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                persona_id: personaId,
                research_file: researchFile,
                analysis_types: analysisTypes
            })
        });
        
        const data = await response.json();
        
        if (data.job_id) {
            currentJobId = data.job_id;
            pollInterval = setInterval(checkStatus, 2000);
        } else {
            throw new Error(data.error || 'Failed to start analysis');
        }
    } catch (err) {
        alert('Error: ' + err.message);
        resetForm();
    }
});

async function checkStatus() {
    if (!currentJobId) return;
    
    try {
        const response = await fetch(`/api/insights/${currentJobId}/status`);
        const data = await response.json();
        
        document.getElementById('progressBar').style.width = data.progress + '%';
        document.getElementById('progressMessage').textContent = data.message;
        
        if (data.status === 'completed') {
            clearInterval(pollInterval);
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').classList.add('bg-success');
            
            setTimeout(() => {
                if (data.result && data.result.filename) {
                    window.location.href = `/insights/${data.persona_id}/${data.result.filename}`;
                } else {
                    window.location.reload();
                }
            }, 1000);
        } else if (data.status === 'failed') {
            clearInterval(pollInterval);
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').classList.add('bg-danger');
            alert('Analysis failed: ' + data.message);
            resetForm();
        }
    } catch (err) {
        console.error('Status check error:', err);
    }
}

function resetForm() {
    document.getElementById('btnGenerate').disabled = false;
    document.getElementById('progressContainer').classList.add('d-none');
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').classList.remove('bg-success', 'bg-danger');
    document.getElementById('progressBar').classList.add('progress-bar-animated');
    currentJobId = null;
    if (pollInterval) clearInterval(pollInterval);
}
</script>
{% endblock %}
